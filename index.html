<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>버티컬 매칭 시스템 (코트 순차 분배)</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>버티컬 매칭 시스템 (코트 순차 분배)</h1>
      <div class="sub">N게임 자동생성 / 코트별 게임매칭 / 수동 매칭 / 고티어 옵션(★) / 하이브리드 Phase(휴식/중복/비율)</div>
    </div>
    <div class="row">
      <button class="btn-ghost" onclick="exportToGoogleSheet()">구글시트 전송</button>
      <button class="btn-ghost" onclick="seedSample()">참가자 불러오기</button>
      <button class="btn-ghost" onclick="resetAll()">초기화</button>
    </div>
  </header>

  <div class="grid">
    <!-- Left -->
    <div class="card">
      <div class="row">
        <span class="pill"><strong>코트</strong> <span id="courtCount">1</span></span>
        <span class="pill"><strong>진행중</strong> <span id="playingCount">0</span></span>
        <span class="pill"><strong>대기(늦참 제외)</strong> <span id="waitingCount">0</span></span>
        <span class="pill"><strong>최대-최소 게임수</strong> <span id="diffGames">-</span></span>

        <span class="pill"><strong>목표비율</strong> <span id="targetRatioText">-</span></span>

        <span class="pill"><strong>휴식강제 대상</strong> <span id="restForcedCount">0</span></span>
        <span class="right"></span>
      </div>

      <div style="margin-top:12px" class="row">
        <span class="pill"><strong>N게임 자동생성</strong></span>
        <select id="batchCount"></select>
        <button class="btn-primary" onclick="generateBatchMatches()">자동 생성</button>
        <button class="btn-danger" onclick="clearScheduledGames()">자동경기삭제</button>
        <button class="btn-ghost" onclick="openMatchOptionsModal()">매칭옵션</button>
        <button class="btn-ghost" onclick="toggleFinishedDrawer()">종료목록 <span id="finishedCount">(0)</span></button>
      </div>

      <div class="divider"></div>
      <div class="row">
        <h2 style="margin-top:0">코트 현황</h2>
        <span class="right"></span>
        <button class="btn-ghost" onclick="removeCourt()">코트-</button>
        <button class="btn-primary" onclick="addCourt()">코트+</button>
      </div>

      <div id="courts" style="margin-top: 1%;"></div>

      <div class="divider"></div>

      <h2 style="margin-top:0">배치 목록</h2>
      <div class="hint">
        ✅ <b>휴식강제(2연속자 다음 1경기 쉬기)</b>를 전역 startSeq로 계산(코트 비동기 종료 포함)<br/>
        ✅ <b>3인중복</b>은 <b>최근 N경기</b> 기준(기본 N=14)으로 Phase에 따라 하드/강/약/해제<br/>
        ✅ <b>비율추적</b>은 <b>최근 W경기</b> 기준(기본 W=18)으로 Phase에 따라 가중치 조절<br/>
        ✅ <b>3:1(남3여1/여3남1)</b>은 옵션 OFF면 금지 / ON이면 <b>막힘 방지 세이프티</b>로 “예방(③) + 최종보장” 단계적 허용<br/>
        ✅ <b>늦참 해제(합류)</b> 인원은 균등 기준(min)에서 제외하여 “늦참 때문에 전체가 잠기는 현상”을 방지합니다.<br/>
        ✅ <b>합류 직후</b>에는 자동으로 “융화 모드”가 켜져 막힘을 줄이고 자연스럽게 섞이도록 제약을 한시 완화합니다.<br/>
      </div>
      <div id="scheduledArea" style="margin-top:10px"></div>
    </div>

    <!-- Right -->
    <div class="card">
      <div class="row">
        <h2 style="margin:0">참여자 관리</h2>
        <span class="right"></span>
        <button class="btn-primary" onclick="openAddPlayerModal()">참가자 추가</button>
      </div>
      <div class="hint" style="margin-top:8px">
        - 늦참(O)은 매칭(자동/코트/수동)에서 제외됩니다.<br/>
        - 참여자 목록 정렬: <b>이름 가나다(ㄱㄴㄷ) 순</b>
      </div>

      <div style="overflow-x:auto;margin-top:10px">
        <table>
          <thead>
          <tr>
            <th>이름</th>
            <th>성별</th>
            <th>급수</th>
            <th class="center">게임수</th>
            <th class="center">셔틀콕</th>
            <th class="center">늦참</th>
            <th class="center">삭제</th>
          </tr>
          </thead>
          <tbody id="playerTbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Add Player Modal -->
<div class="modalBack" id="addPlayerBack">
  <div class="modal">
    <h3>참여자 추가</h3>
    <div class="two">
      <div>
        <div class="mini">이름</div>
        <input id="apName" placeholder="이름" />
      </div>
      <div>
        <div class="mini">성별</div>
        <select id="apGender">
          <option value="남">남</option>
          <option value="여">여</option>
        </select>
      </div>
      <div>
        <div class="mini">급수</div>
        <select id="apLevel">
          <option value="E">E</option>
          <option value="D">D</option>
          <option value="C">C</option>
          <option value="B">B</option>
          <option value="A">A</option>
          <option value="S">S</option>
        </select>
      </div>
      <div>
        <div class="mini">기존 게임수</div>
        <input id="apGames" type="number" value="0" min="0" />
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn-primary" onclick="addPlayerFromModal()">저장</button>
      <button class="btn-ghost right" onclick="closeAddPlayerModal()">닫기</button>
    </div>
  </div>
</div>

<!-- Match Options Modal -->
<div class="modalBack" id="matchOptBack">
  <div class="modal">
    <h3>매칭 옵션</h3>
    <div class="hint">
      - 고티어매칭: 남/여 각각 N의 20% 정도를 고티어로(★) 생성 (고티어 출전 로직은 유지)<br/>
      - <b>하이브리드 Phase</b>: Phase1(강제) → Phase4(최후) 순으로 자동 완화<br/>
      - <b>N(3인중복 체크)</b> / <b>W(비율 추적)</b>는 라이브/배치 모두 적용됩니다.<br/>
      - ✅ <b>N은 사용자가 원하는 값으로 직접 설정 가능</b>합니다(저장/재오픈 시 그대로 유지).
    </div>
    <div class="divider"></div>

    <label class="row" style="gap:8px">
      <span style="min-width:92px">성비 선택</span>
      <select id="optGenderMode">
        <option value="auto">자동(권장)</option>
        <option value="equal">남녀균등(5:5)</option>
        <option value="enough">여자 충분</option>
        <option value="few">여자 소수</option>
        <option value="very_few">여자 극소수</option>
      </select>
    </label>

    <div class="infoBox" style="margin-top:10px" id="genderInfoBox">(성비/목표비율/NW/추천값)</div>

    <div class="divider"></div>

    <div class="two">
      <div>
        <div class="mini">3인중복 체크 범위 N (최근 N경기)</div>
        <!-- ✅ FIX: min=4로 변경 (기존 10이 버그 원인 중 하나) -->
        <input id="optOverlapN" type="number" min="4" max="30" step="1" />
        <div class="mini" style="margin-top:6px">권장: 8~16 (기본 14) / 인원이 적거나 여자 풀이 얇으면 8~12 추천</div>
      </div>
      <div>
        <div class="mini">비율추적 윈도우 W (최근 W경기)</div>
        <input id="optRatioW" type="number" min="8" max="40" step="1" />
        <div class="mini" style="margin-top:6px">권장: 16~22 (기본 18)</div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn-ghost" onclick="applyRecommendedNW()">추천값 적용</button>
      <span class="mini">※ 활동 인원(늦참 제외) + 배치 선택 경기수 기준 자동 추천</span>
    </div>

    <div class="divider"></div>

    <label class="row" style="gap:8px">
      <input type="checkbox" id="optPreferF4" />
      <span>여4 선호</span>
    </label>

    <label class="row" style="gap:8px;margin-top:8px">
      <input type="checkbox" id="optAllowThreeOne" />
      <span>3:1 매칭 허용</span>
      <span id="optThreeOneRec" class="recText">(권장: -)</span>
    </label>

    <label class="row" style="gap:8px;margin-top:8px">
      <input type="checkbox" id="optHighTier" />
      <span>고티어매칭(★)</span>
    </label>

    <div class="divider"></div>

    <div class="infoBox">
      <b>휴식강제 여성 예외:</b> 최대 <b>2명</b>까지 허용(Phase1/2 hard에서도 여성 2명까지는 예외로 포함 가능)<br/>
      <span class="mini">※ 남성 휴식 대상은 hard에서는 계속 제외(운영 안정성)</span>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn-primary" onclick="saveMatchOptions()">저장</button>
      <button class="btn-ghost right" onclick="closeMatchOptionsModal()">닫기</button>
    </div>
  </div>
</div>

<!-- Manual Match Modal -->
<div class="modalBack" id="manualBack">
  <div class="modal">
    <h3>수동 매칭</h3>
    <div class="hint">늦참(O) 참여자는 목록에 표시되지 않으며 선택도 불가합니다.</div>
    <div class="two" style="margin-top:10px">
      <div><select id="m1"></select></div>
      <div><select id="m2"></select></div>
      <div><select id="m3"></select></div>
      <div><select id="m4"></select></div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn-primary" onclick="saveManualGame()">시작</button>
      <button class="btn-ghost right" onclick="closeManualModal()">닫기</button>
    </div>
  </div>
</div>

<!-- Finished Drawer -->
<div class="drawer" id="finishedDrawer">
  <div class="drawerHead">
    <strong>종료된 게임</strong>
    <span class="right"></span>
    <button class="btn-ghost" onclick="toggleFinishedDrawer(false)">닫기</button>
  </div>
  <div id="finishedArea"></div>
</div>

<script src="js/google-sheet.js"></script>
<script src="js/app-core.js"></script>
<script src="js/app-render.js"></script>
</body>
</html>
